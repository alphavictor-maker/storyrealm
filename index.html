<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Primary Meta Tags -->
    <title>StoryRealm ‚Äî AI Interactive Fiction | Create Your Own Adventure Stories</title>
    <meta name="title" content="StoryRealm ‚Äî AI Interactive Fiction | Create Your Own Adventure Stories">
    <meta name="description" content="Dive into AI-powered interactive fiction. Choose your own adventure across Fantasy, Mystery, Sci-Fi, Horror, Romance & Historical realms. New stories daily. Your choices shape the narrative.">
    <meta name="keywords" content="interactive fiction, AI stories, choose your own adventure, text adventure, story game, AI storytelling, fantasy stories, mystery stories, sci-fi stories, horror stories, romance stories, narrative game, story generator, creative writing, immersive fiction">
    <meta name="author" content="AVA Applications, LLC">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="https://mystoryrealm.com">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://mystoryrealm.com">
    <meta property="og:title" content="StoryRealm ‚Äî AI Interactive Fiction | Create Your Own Adventure">
    <meta property="og:description" content="Dive into AI-powered interactive fiction. Choose your own adventure across 6 unique realms. New stories daily. Your choices shape the narrative.">
    <meta property="og:image" content="https://mystoryrealm.com/og-image.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="StoryRealm">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://mystoryrealm.com">
    <meta name="twitter:title" content="StoryRealm ‚Äî AI Interactive Fiction | Create Your Own Adventure">
    <meta name="twitter:description" content="Dive into AI-powered interactive fiction. Choose your own adventure across 6 unique realms. New stories daily.">
    <meta name="twitter:image" content="https://mystoryrealm.com/og-image.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìñ</text></svg>">
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#0a0a0f">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    
    <!-- Additional SEO -->
    <meta name="application-name" content="StoryRealm">
    <meta name="apple-mobile-web-app-title" content="StoryRealm">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Structured Data / JSON-LD -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "StoryRealm",
        "description": "AI-powered interactive fiction platform where you choose your own adventure across Fantasy, Mystery, Sci-Fi, Horror, Romance, and Historical realms.",
        "url": "https://mystoryrealm.com",
        "applicationCategory": "GameApplication",
        "genre": "Interactive Fiction",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "description": "Free daily story, Premium unlimited access available"
        },
        "author": {
            "@type": "Organization",
            "name": "AVA Applications, LLC"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "150"
        }
    }
    </script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Pro:ital,wght@0,300;0,400;0,500;1,300;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-deep: #0a0a0f;
            --bg-card: #12121a;
            --bg-hover: #1a1a25;
            --accent-gold: #c9a227;
            --accent-gold-dim: #8b7019;
            --accent-ember: #e85d04;
            --text-primary: #e8e6e3;
            --text-secondary: #9a9590;
            --text-dim: #5a5550;
            --border-subtle: rgba(201, 162, 39, 0.15);
            --shadow-glow: rgba(201, 162, 39, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Crimson Pro', Georgia, serif;
            background: var(--bg-deep);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.7;
            overflow-x: hidden;
        }

        /* Ambient background effect */
        .ambient-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 20%, rgba(201, 162, 39, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 80%, rgba(232, 93, 4, 0.02) 0%, transparent 50%),
                radial-gradient(ellipse 100% 100% at 50% 0%, rgba(30, 30, 60, 0.4) 0%, transparent 60%);
        }

        /* Star field canvas */
        #starfield {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        .container {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
        }

        /* Header */
        header {
            text-align: center;
            padding: 3rem 0 2rem;
            animation: fadeDown 0.8s ease-out;
        }

        @keyframes fadeDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .logo {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #f4e4ba 50%, var(--accent-gold) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 40px var(--shadow-glow);
        }

        .tagline {
            font-size: 1.1rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 0.5rem;
            font-weight: 300;
        }

        /* Daily info bar */
        .daily-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            margin: 2rem 0;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            animation: fadeIn 0.8s ease-out 0.2s both;
            flex-wrap: wrap;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .daily-date {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--accent-gold);
            letter-spacing: 0.1em;
        }

        .daily-separator {
            width: 1px;
            height: 20px;
            background: var(--border-subtle);
        }

        .realms-played {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .realms-played span {
            color: var(--accent-gold);
            font-weight: 500;
        }

        .upgrade-btn {
            background: transparent;
            border: 1px solid var(--accent-gold-dim);
            color: var(--accent-gold);
            padding: 0.4rem 1rem;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .upgrade-btn:hover {
            background: var(--accent-gold);
            color: var(--bg-deep);
        }

        .library-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 0.4rem 1rem;
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 4px;
        }

        .library-btn:hover {
            border-color: var(--accent-gold-dim);
            color: var(--accent-gold);
        }

        /* Saved Stories */
        .saved-stories-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .saved-story-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .saved-story-card:hover {
            border-color: var(--accent-gold-dim);
            transform: translateX(4px);
        }

        .saved-story-icon {
            font-size: 1.8rem;
            flex-shrink: 0;
        }

        .saved-story-info {
            flex: 1;
            min-width: 0;
        }

        .saved-story-genre {
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            color: var(--accent-gold);
            letter-spacing: 0.05em;
        }

        .saved-story-date {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 0.5rem;
        }

        .saved-story-preview {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            line-height: 1.5;
        }

        .delete-story-btn {
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            transition: color 0.3s ease;
            flex-shrink: 0;
        }

        .delete-story-btn:hover {
            color: #e85d04;
        }

        .empty-library {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .empty-hint {
            font-size: 0.9rem;
            color: var(--text-dim);
            margin-top: 0.5rem;
        }

        .saved-segment {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .saved-segment:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .story-date {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        /* Premium locked button style */
        .secondary-btn.premium-locked {
            border-color: var(--accent-gold-dim);
            color: var(--accent-gold-dim);
        }

        .secondary-btn.premium-locked:hover {
            background: rgba(201, 162, 39, 0.1);
        }

        .btn-premium-tag {
            font-size: 0.65rem;
            background: var(--accent-gold-dim);
            color: var(--bg-deep);
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            margin-left: 0.5rem;
            vertical-align: middle;
        }

        .secondary-btn.saved {
            color: #8fbc8f;
            border-color: rgba(100, 200, 100, 0.3);
        }

        /* Upgrade Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 420px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: transparent;
            border: none;
            color: var(--text-dim);
            font-size: 1.25rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.6rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 1.5rem;
        }

        .premium-features {
            text-align: left;
            margin-bottom: 1.5rem;
        }

        .premium-feature {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 0;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .feature-icon {
            font-size: 1.1rem;
        }

        .pricing-options {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .pricing-card {
            flex: 1;
            background: var(--bg-deep);
            border: 2px solid var(--border-subtle);
            border-radius: 10px;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .pricing-card:hover {
            border-color: var(--accent-gold-dim);
        }

        .pricing-card.featured {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.05);
        }

        .pricing-card.selected {
            border-color: var(--accent-gold);
            box-shadow: 0 0 20px var(--shadow-glow);
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-gold);
            color: var(--bg-deep);
            font-family: 'Cinzel', serif;
            font-size: 0.65rem;
            letter-spacing: 0.05em;
            padding: 0.2rem 0.6rem;
            border-radius: 3px;
        }

        .plan-name {
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }

        .plan-price {
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .plan-period {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .subscribe-btn {
            width: 100%;
            background: var(--accent-gold);
            border: none;
            color: var(--bg-deep);
            padding: 1rem;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .subscribe-btn:hover {
            background: #dbb42e;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(201, 162, 39, 0.3);
        }

        .modal-note {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .limit-message {
            background: var(--bg-deep);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .limit-message p {
            margin: 0;
        }

        .limit-or {
            color: var(--text-dim);
            font-style: italic;
            margin: 0.75rem 0 !important;
        }

        .limit-message strong {
            color: var(--accent-gold);
        }

        /* Auth Screen */
        .auth-screen {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .auth-box {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 2.5rem;
            max-width: 400px;
            width: 100%;
        }

        .auth-title {
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-style: italic;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .auth-input {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.9rem 1rem;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--accent-gold-dim);
        }

        .auth-input::placeholder {
            color: var(--text-dim);
        }

        .auth-btn {
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            padding: 0.9rem;
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            letter-spacing: 0.05em;
            color: var(--bg-deep);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .auth-btn:hover {
            background: #dbb42e;
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 1.25rem 0;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        .auth-google-btn {
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.9rem;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            width: 100%;
        }

        .auth-google-btn:hover {
            border-color: var(--accent-gold-dim);
            background: var(--bg-hover);
        }

        .auth-switch {
            margin-top: 1.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-switch a {
            color: var(--accent-gold);
            text-decoration: none;
            cursor: pointer;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: rgba(232, 93, 4, 0.1);
            border: 1px solid rgba(232, 93, 4, 0.3);
            color: #e85d04;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .auth-success {
            background: rgba(100, 200, 100, 0.1);
            border: 1px solid rgba(100, 200, 100, 0.3);
            color: #8fbc8f;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-success.show {
            display: block;
        }

        .user-bar {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .user-email {
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-dim);
            padding: 0.3rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            border-color: var(--accent-gold-dim);
            color: var(--text-secondary);
        }

        /* Screens */
        .screen {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .screen.active {
            display: block;
        }

        /* Genre Selection */
        .section-title {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            font-weight: 600;
            letter-spacing: 0.1em;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .section-subtitle {
            font-size: 0.95rem;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 1.5rem;
            font-style: italic;
        }

        .genre-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .genre-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .genre-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, transparent 0%, rgba(201, 162, 39, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .genre-card:hover {
            border-color: var(--accent-gold-dim);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3), 0 0 20px var(--shadow-glow);
        }

        .genre-card:hover::before {
            opacity: 1;
        }

        .genre-card.completed {
            opacity: 0.6;
        }

        .genre-card.completed:hover {
            transform: none;
            box-shadow: none;
        }

        .genre-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .genre-name {
            font-family: 'Cinzel', serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .genre-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 0.5rem;
        }

        .genre-seed {
            font-size: 0.8rem;
            color: var(--text-dim);
            border-top: 1px solid var(--border-subtle);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        .genre-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .genre-card.locked:hover {
            transform: none;
            border-color: var(--border-subtle);
            box-shadow: none;
        }

        .badge {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            font-size: 0.65rem;
            font-family: 'Cinzel', serif;
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
            letter-spacing: 0.05em;
        }

        .badge.premium {
            background: var(--accent-gold-dim);
            color: var(--bg-deep);
        }

        .badge.free {
            background: rgba(100, 200, 100, 0.2);
            color: #8fbc8f;
            border: 1px solid rgba(100, 200, 100, 0.3);
        }

        .badge.premium-unlocked {
            background: rgba(201, 162, 39, 0.15);
            color: var(--accent-gold);
            border: 1px solid var(--accent-gold-dim);
        }

        .badge.available {
            background: rgba(100, 180, 255, 0.15);
            color: #7eb8ff;
            border: 1px solid rgba(100, 180, 255, 0.3);
        }

        .badge.completed {
            background: rgba(100, 200, 100, 0.2);
            color: #8fbc8f;
            border: 1px solid rgba(100, 200, 100, 0.3);
        }

        /* Story Screen */
        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .back-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.3s ease;
        }

        .back-btn:hover {
            color: var(--accent-gold);
        }

        .story-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .story-genre-badge {
            font-family: 'Cinzel', serif;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
            padding: 0.4rem 1rem;
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
        }

        /* Weave Progress */
        .weave-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .weave-label {
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            color: var(--text-secondary);
            letter-spacing: 0.05em;
        }

        .weave-dots {
            display: flex;
            gap: 0.4rem;
        }

        .weave-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-hover);
            border: 1px solid var(--border-subtle);
            transition: all 0.3s ease;
        }

        .weave-dot.filled {
            background: var(--accent-gold);
            border-color: var(--accent-gold);
            box-shadow: 0 0 8px var(--shadow-glow);
        }

        .weave-dot.current {
            border-color: var(--accent-gold);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(201, 162, 39, 0.4); }
            50% { box-shadow: 0 0 0 6px rgba(201, 162, 39, 0); }
        }

        .story-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            min-height: 200px;
        }

        .story-text {
            font-size: 1.15rem;
            line-height: 1.9;
            color: var(--text-primary);
        }

        .story-text p {
            margin-bottom: 1rem;
        }

        .story-text p:last-child {
            margin-bottom: 0;
        }

        /* Loading state */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-style: italic;
            font-size: 1rem;
        }

        /* Choices */
        .choices-container {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .choice-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1rem 1.25rem;
            text-align: left;
            font-family: 'Crimson Pro', serif;
            font-size: 1.05rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .choice-btn::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--accent-gold);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .choice-btn:hover {
            border-color: var(--accent-gold-dim);
            background: var(--bg-hover);
            padding-left: 1.5rem;
        }

        .choice-btn:hover::before {
            transform: scaleY(1);
        }

        .choice-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .choice-btn:disabled:hover {
            border-color: var(--border-subtle);
            background: var(--bg-card);
            padding-left: 1.25rem;
        }

        .choice-btn:disabled:hover::before {
            transform: scaleY(0);
        }

        /* Story history */
        .story-history {
            margin-bottom: 1.5rem;
        }

        .history-segment {
            padding: 1.5rem 0;
            border-bottom: 1px solid var(--border-subtle);
            opacity: 0.7;
        }

        .history-segment:last-child {
            border-bottom: none;
        }

        .history-choice {
            color: var(--accent-gold);
            font-style: italic;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .history-choice::before {
            content: '‚Ü≥ ';
            opacity: 0.5;
        }

        /* Custom choice input */
        .custom-choice {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px dashed var(--border-subtle);
        }

        .custom-input-wrapper {
            display: flex;
            gap: 0.75rem;
        }

        .custom-input {
            flex: 1;
            background: var(--bg-deep);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-family: 'Crimson Pro', serif;
            font-size: 1rem;
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .custom-input:focus {
            outline: none;
            border-color: var(--accent-gold-dim);
        }

        .custom-input::placeholder {
            color: var(--text-dim);
            font-style: italic;
        }

        .custom-submit {
            background: var(--accent-gold);
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-family: 'Cinzel', serif;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
            color: var(--bg-deep);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .custom-submit:hover {
            background: #dbb42e;
            transform: translateY(-1px);
        }

        .custom-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Story Ending Screen */
        .ending-screen {
            text-align: center;
            padding: 2rem;
            animation: fadeIn 0.8s ease-out;
        }

        .ending-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .ending-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--accent-gold);
            margin-bottom: 0.5rem;
        }

        .ending-subtitle {
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 2rem;
            font-size: 1.1rem;
        }

        .ending-narrative {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: left;
        }

        .ending-narrative .story-text {
            font-size: 1.1rem;
        }

        .ending-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }

        .primary-btn {
            background: var(--accent-gold);
            border: none;
            color: var(--bg-deep);
            padding: 0.9rem 2.5rem;
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .primary-btn:hover {
            background: #dbb42e;
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(201, 162, 39, 0.3);
        }

        .secondary-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            padding: 0.7rem 1.5rem;
            font-family: 'Crimson Pro', serif;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .secondary-btn:hover {
            border-color: var(--accent-gold-dim);
            color: var(--accent-gold);
        }

        /* Past Adventures */
        .past-adventures {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-subtle);
        }

        .past-title {
            font-family: 'Cinzel', serif;
            font-size: 1rem;
            color: var(--text-secondary);
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .past-title .premium-tag {
            font-size: 0.7rem;
            background: var(--accent-gold-dim);
            color: var(--bg-deep);
            padding: 0.15rem 0.5rem;
            border-radius: 3px;
        }

        .past-days {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .past-day {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.85rem;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .past-day:hover {
            border-color: var(--accent-gold-dim);
            color: var(--text-secondary);
        }

        .past-day.locked {
            cursor: not-allowed;
            opacity: 0.5;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 3rem 0 2rem;
            color: var(--text-dim);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--accent-gold-dim);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        footer a:hover {
            color: var(--accent-gold);
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 1rem;
            }

            .logo {
                font-size: 1.8rem;
            }

            .genre-grid {
                grid-template-columns: 1fr;
            }

            .story-content {
                padding: 1.5rem;
            }

            .story-text {
                font-size: 1.05rem;
            }

            .custom-input-wrapper {
                flex-direction: column;
            }

            .daily-bar {
                flex-direction: column;
                gap: 0.75rem;
            }

            .daily-separator {
                display: none;
            }
        }

        /* Animations for story segments */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .story-segment-new {
            animation: slideIn 0.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="ambient-bg"></div>
    <canvas id="starfield"></canvas>
    <div class="noise-overlay"></div>

    <div class="container">
        <header>
            <h1 class="logo">STORYREALM</h1>
            <p class="tagline">Your path. Your destiny. New tales daily.</p>
        </header>

        <div class="daily-bar" id="dailyBar" style="display: none;">
            <span class="daily-date" id="todayDate">TODAY ‚Äî NOV 26, 2024</span>
            <div class="daily-separator"></div>
            <span class="realms-played">Today's free realm: <span id="freeRealmName">Loading...</span></span>
            <button class="library-btn" onclick="viewSavedStories()">üìö My Library</button>
            <button class="upgrade-btn" onclick="showUpgrade()">GO PREMIUM</button>
            <div class="daily-separator"></div>
            <div class="user-bar">
                <span class="user-email" id="userEmail"></span>
                <button class="logout-btn" onclick="handleLogout()">Log out</button>
            </div>
        </div>

        <!-- Auth Screen -->
        <div class="screen active" id="authScreen">
            <div class="auth-screen">
                <div class="auth-box">
                    <h2 class="auth-title" id="authTitle">Begin Your Journey</h2>
                    <p class="auth-subtitle" id="authSubtitle">Sign up for one free adventure daily</p>
                    
                    <div class="auth-error" id="authError"></div>
                    <div class="auth-success" id="authSuccess"></div>

                    <div class="auth-form">
                        <input type="email" class="auth-input" id="authEmail" placeholder="Email address">
                        <input type="password" class="auth-input" id="authPassword" placeholder="Password">
                        <button class="auth-btn" id="authBtn" onclick="handleAuth()">Create Account</button>
                    </div>

                    <p class="auth-switch" id="authSwitch">
                        Already have an account? <a onclick="toggleAuthMode()">Sign in</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- Genre Selection Screen -->
        <div class="screen active" id="genreScreen">
            <h2 class="section-title">Today's Realms</h2>
            <p class="section-subtitle" id="realmSubtitle">One free realm daily ‚Äî premium unlocks all six</p>
            
            <div class="genre-grid" id="genreGrid">
                <!-- Populated by JS -->
            </div>

            <div class="past-adventures">
                <div class="past-title">
                    Past Adventures <span class="premium-tag">PREMIUM</span>
                </div>
                <div class="past-days" id="pastDays">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Story Screen -->
        <div class="screen" id="storyScreen">
            <div class="story-header">
                <button class="back-btn" onclick="backToRealms()">
                    ‚Üê Back to Realms
                </button>
                <div class="story-meta">
                    <span class="story-genre-badge" id="currentGenreBadge">FANTASY</span>
                </div>
            </div>

            <div class="weave-progress">
                <span class="weave-label">WEAVE</span>
                <div class="weave-dots" id="weaveDots">
                    <!-- Populated by JS -->
                </div>
            </div>

            <div class="story-content">
                <div class="story-history" id="storyHistory"></div>
                <div class="story-segment-new" id="currentStory">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Weaving your tale...</div>
                    </div>
                </div>
            </div>

            <div class="choices-container" id="choicesContainer"></div>
        </div>

        <!-- Ending Screen -->
        <div class="screen" id="endingScreen">
            <div class="story-header">
                <button class="back-btn" onclick="backToRealms()">
                    ‚Üê Back to Realms
                </button>
                <div class="story-meta">
                    <span class="story-genre-badge" id="endingGenreBadge">FANTASY</span>
                </div>
            </div>

            <div class="ending-screen">
                <div class="ending-icon" id="endingIcon">üìú</div>
                <h2 class="ending-title">Your Tale is Complete</h2>
                <p class="ending-subtitle" id="endingSubtitle">You forged your own destiny</p>
                
                <div class="ending-narrative">
                    <div class="story-text" id="endingNarrative"></div>
                </div>

                <div class="ending-actions">
                    <button class="primary-btn" onclick="backToRealms()">Explore Another Realm</button>
                    <button class="secondary-btn" id="saveStoryBtn">üíæ Save Story</button>
                    <button class="secondary-btn" onclick="replayRealm()">Replay &amp; Choose Differently</button>
                </div>
            </div>
        </div>

        <!-- Library Screen -->
        <div class="screen" id="libraryScreen">
            <div class="story-header">
                <button class="back-btn" onclick="backToRealms()">
                    ‚Üê Back to Realms
                </button>
                <div class="story-meta">
                    <span class="story-genre-badge">MY LIBRARY</span>
                </div>
            </div>

            <h2 class="section-title">Saved Stories</h2>
            <p class="section-subtitle">Your collection of completed adventures</p>

            <div class="saved-stories-list" id="savedStoriesList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- View Saved Story Screen -->
        <div class="screen" id="viewStoryScreen">
            <div class="story-header">
                <button class="back-btn" onclick="viewSavedStories()">
                    ‚Üê Back to Library
                </button>
                <div class="story-meta">
                    <span class="story-genre-badge" id="viewStoryGenre">FANTASY</span>
                    <span class="story-date" id="viewStoryDate"></span>
                </div>
            </div>

            <div class="story-content">
                <div id="viewStoryContent"></div>
            </div>

            <div class="ending-actions">
                <button class="secondary-btn" onclick="viewSavedStories()">Back to Library</button>
            </div>
        </div>

        <!-- Daily Limit Modal -->
        <div class="modal-overlay" id="limitModal">
            <div class="modal">
                <button class="modal-close" onclick="closeLimitModal()">‚úï</button>
                <div class="modal-icon">üåô</div>
                <h2 class="modal-title">Adventure Complete!</h2>
                <p class="modal-subtitle">You've finished today's free story.</p>

                <div class="limit-message">
                    <p>Your next free adventure unlocks at midnight.</p>
                    <p class="limit-or">‚Äî or ‚Äî</p>
                    <p>Go premium for <strong>unlimited stories</strong> in all realms, anytime.</p>
                </div>

                <button class="subscribe-btn" onclick="closeLimitModal(); showUpgrade();">
                    Unlock Premium
                </button>
                <button class="secondary-btn" onclick="closeLimitModal()" style="width: 100%; margin-top: 0.5rem;">
                    I'll wait until tomorrow
                </button>
            </div>
        </div>

        <!-- Upgrade Modal -->
        <div class="modal-overlay" id="upgradeModal">
            <div class="modal">
                <button class="modal-close" onclick="closeUpgrade()">‚úï</button>
                <div class="modal-icon">‚ú®</div>
                <h2 class="modal-title">Unlock Premium</h2>
                <p class="modal-subtitle">Unlimited stories. Endless adventures.</p>

                <div class="premium-features">
                    <div class="premium-feature">
                        <span class="feature-icon">üåü</span>
                        <span>All 6 realms every day</span>
                    </div>
                    <div class="premium-feature">
                        <span class="feature-icon">üíæ</span>
                        <span>Save stories to your library</span>
                    </div>
                    <div class="premium-feature">
                        <span class="feature-icon">üìÖ</span>
                        <span>Access past adventures</span>
                    </div>
                    <div class="premium-feature">
                        <span class="feature-icon">üé≠</span>
                        <span>Exclusive story seeds</span>
                    </div>
                </div>

                <div class="pricing-options">
                    <div class="pricing-card" onclick="selectPlan('monthly')">
                        <div class="plan-name">Monthly</div>
                        <div class="plan-price">$9.99</div>
                        <div class="plan-period">per month</div>
                    </div>
                    <div class="pricing-card featured" onclick="selectPlan('yearly')">
                        <div class="plan-badge">SAVE 42%</div>
                        <div class="plan-name">Yearly</div>
                        <div class="plan-price">$69.99</div>
                        <div class="plan-period">per year</div>
                    </div>
                </div>

                <button class="subscribe-btn" onclick="handleSubscribe()">
                    Start Premium
                </button>
                <p class="modal-note">Cancel anytime. Secure payment via Stripe.</p>
            </div>
        </div>

        <footer>
            <p>A new free realm unlocks daily at midnight ‚Ä¢ <a href="#" onclick="showUpgrade()">Go Premium</a> for all realms</p>
            <p style="margin-top: 1rem; opacity: 0.6;">A product of AVA Applications, LLC</p>
        </footer>
    </div>

    <script>
        // ==================== STARFIELD ====================
        function initStarfield() {
            const canvas = document.getElementById('starfield');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            // Create stars
            const stars = [];
            const numStars = 150;
            
            for (let i = 0; i < numStars; i++) {
                stars.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: Math.random() * 2 + 0.5,
                    opacity: Math.random() * 0.8 + 0.2,
                    twinkleSpeed: Math.random() * 0.02 + 0.005,
                    twinkleOffset: Math.random() * Math.PI * 2,
                    isGold: Math.random() < 0.1
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                const time = Date.now() * 0.001;
                
                stars.forEach(function(star) {
                    const twinkle = Math.sin(time * star.twinkleSpeed * 10 + star.twinkleOffset) * 0.3 + 0.7;
                    const currentOpacity = star.opacity * twinkle;
                    
                    ctx.beginPath();
                    ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                    
                    if (star.isGold) {
                        ctx.fillStyle = 'rgba(201, 162, 39, ' + currentOpacity + ')';
                    } else {
                        ctx.fillStyle = 'rgba(255, 255, 255, ' + currentOpacity + ')';
                    }
                    
                    ctx.fill();
                    
                    if (star.size > 1.5) {
                        ctx.beginPath();
                        ctx.arc(star.x, star.y, star.size * 2, 0, Math.PI * 2);
                        if (star.isGold) {
                            ctx.fillStyle = 'rgba(201, 162, 39, ' + (currentOpacity * 0.1) + ')';
                        } else {
                            ctx.fillStyle = 'rgba(255, 255, 255, ' + (currentOpacity * 0.1) + ')';
                        }
                        ctx.fill();
                    }
                });
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // ==================== CONFIG ====================
        const TOTAL_WEAVES = 8;
        const FREE_REALMS_PER_DAY = 1;

        // Supabase config
        const SUPABASE_URL = 'https://sbpzrlwluceuaeofxmbz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNicHpybHdsdWNldWFlb2Z4bWJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNjY5MzEsImV4cCI6MjA3OTg0MjkzMX0.KKYzpj7NyO5fz43eW3ML273vCpGew0hlEjSoIsqbfM4';
        
        let supabase;
        let currentUser = null;
        let authMode = 'signup'; // 'signup' or 'login'

        // ==================== STATE ====================
        // ==================== STATE ====================
        let state = {
            currentGenre: null,
            currentWeave: 0,
            storyHistory: [],
            completedRealms: [],
            savedStories: [],
            chosenFreeRealm: null,
            completedToday: false,
            todayKey: null,
            isLoading: false,
            isPremium: false
        };

        // ==================== AUTH ====================
        function initSupabase() {
            // Check if Supabase is available and configured
            if (typeof window.supabase === 'undefined' || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                console.log('Supabase not configured - running in demo mode');
                // Skip auth in demo mode, go straight to app
                runDemoMode();
                return;
            }

            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            
            // Check for existing session
            supabase.auth.getSession().then(function(result) {
                if (result.data.session) {
                    handleAuthSuccess(result.data.session.user);
                }
            });

            // Listen for auth changes
            supabase.auth.onAuthStateChange(function(event, session) {
                if (event === 'SIGNED_IN' && session) {
                    handleAuthSuccess(session.user);
                } else if (event === 'SIGNED_OUT') {
                    showAuthScreen();
                }
            });
        }

        function runDemoMode() {
            // Demo mode - no auth required, uses localStorage
            currentUser = { email: 'demo@storyrealm.com', id: 'demo' };
            loadDemoState();
            document.getElementById('userEmail').textContent = 'Demo Mode';
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('dailyBar').style.display = 'flex';
            showScreen('genreScreen');
            updateDailyBar();
            renderGenreGrid();
            renderPastDays();
        }

        function loadDemoState() {
            var saved = localStorage.getItem('storyrealm_demo_state');
            if (saved) {
                var parsed = JSON.parse(saved);
                if (parsed.todayKey !== getTodayKey()) {
                    state.completedRealms = [];
                    state.chosenFreeRealm = null;
                    state.completedToday = false;
                } else {
                    state.completedRealms = parsed.completedRealms || [];
                    state.chosenFreeRealm = parsed.chosenFreeRealm || null;
                    state.completedToday = parsed.completedToday || false;
                }
                state.isPremium = parsed.isPremium || false;
                state.savedStories = parsed.savedStories || [];
            }
            state.todayKey = getTodayKey();
            saveDemoState();
        }

        function saveDemoState() {
            localStorage.setItem('storyrealm_demo_state', JSON.stringify({
                todayKey: state.todayKey,
                completedRealms: state.completedRealms,
                chosenFreeRealm: state.chosenFreeRealm,
                completedToday: state.completedToday,
                savedStories: state.savedStories,
                isPremium: state.isPremium
            }));
        }

        function toggleAuthMode() {
            authMode = authMode === 'signup' ? 'login' : 'signup';
            
            document.getElementById('authTitle').textContent = 
                authMode === 'signup' ? 'Begin Your Journey' : 'Welcome Back';
            document.getElementById('authSubtitle').textContent = 
                authMode === 'signup' ? 'Sign up for one free adventure daily' : 'Sign in to continue your adventures';
            document.getElementById('authBtn').textContent = 
                authMode === 'signup' ? 'Create Account' : 'Sign In';
            document.getElementById('authSwitch').innerHTML = 
                authMode === 'signup' 
                    ? 'Already have an account? <a onclick="toggleAuthMode()">Sign in</a>'
                    : 'New here? <a onclick="toggleAuthMode()">Create account</a>';
            
            hideAuthMessages();
        }

        function showAuthError(message) {
            var errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            document.getElementById('authSuccess').classList.remove('show');
        }

        function showAuthSuccess(message) {
            var successEl = document.getElementById('authSuccess');
            successEl.textContent = message;
            successEl.classList.add('show');
            document.getElementById('authError').classList.remove('show');
        }

        function hideAuthMessages() {
            document.getElementById('authError').classList.remove('show');
            document.getElementById('authSuccess').classList.remove('show');
        }

        async function handleAuth() {
            var email = document.getElementById('authEmail').value.trim();
            var password = document.getElementById('authPassword').value;

            if (!email || !password) {
                showAuthError('Please enter email and password');
                return;
            }

            if (password.length < 6) {
                showAuthError('Password must be at least 6 characters');
                return;
            }

            var btn = document.getElementById('authBtn');
            btn.disabled = true;
            btn.textContent = authMode === 'signup' ? 'Creating account...' : 'Signing in...';
            hideAuthMessages();

            try {
                var result;
                if (authMode === 'signup') {
                    result = await supabase.auth.signUp({ email: email, password: password });
                } else {
                    result = await supabase.auth.signInWithPassword({ email: email, password: password });
                }

                if (result.error) {
                    showAuthError(result.error.message);
                } else if (authMode === 'signup' && !result.data.session) {
                    showAuthSuccess('Check your email to confirm your account!');
                }
            } catch (error) {
                showAuthError('Something went wrong. Please try again.');
            }

            btn.disabled = false;
            btn.textContent = authMode === 'signup' ? 'Create Account' : 'Sign In';
        }

        async function handleGoogleAuth() {
            try {
                var result = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });
                if (result.error) showAuthError(result.error.message);
            } catch (error) {
                showAuthError('Google sign-in failed. Please try again.');
            }
        }

        async function handleLogout() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            showAuthScreen();
        }

        async function handleAuthSuccess(user) {
            currentUser = user;
            document.getElementById('userEmail').textContent = user.email;
            
            // Load user data from server
            await loadUserData();
            
            // Show main app
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('dailyBar').style.display = 'flex';
            showScreen('genreScreen');
            updateDailyBar();
            renderGenreGrid();
            renderPastDays();
        }

        function showAuthScreen() {
            document.getElementById('dailyBar').style.display = 'none';
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('authScreen').classList.add('active');
        }

        async function loadUserData() {
            // Always load from localStorage first as baseline
            loadDemoState();
            
            // If no supabase configured, we're done (demo mode)
            if (!supabase || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                return;
            }

            try {
                var sessionResult = await supabase.auth.getSession();
                var token = sessionResult.data.session ? sessionResult.data.session.access_token : null;
                
                if (!token) return;

                var response = await fetch('/api/user', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });

                if (response.ok) {
                    var userData = await response.json();
                    state.isPremium = userData.is_premium || false;
                    
                    // Use server data if it exists, otherwise keep local
                    if (userData.chosen_realm) {
                        state.chosenFreeRealm = userData.chosen_realm;
                    }
                    if (userData.completed_today) {
                        state.completedToday = userData.completed_today;
                    }
                    if (userData.saved_stories && userData.saved_stories.length > 0) {
                        state.savedStories = userData.saved_stories;
                    }
                    
                    if (state.completedToday && state.chosenFreeRealm) {
                        state.completedRealms = [state.chosenFreeRealm];
                    }
                }
            } catch (error) {
                console.error('Failed to load user data:', error);
                // Keep using localStorage data on error
            }
            
            state.todayKey = getTodayKey();
        }

        async function syncUserAction(action, data) {
            // Always save to localStorage as backup
            saveDemoState();
            
            // If no supabase, we're done
            if (!supabase || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                return;
            }

            try {
                var sessionResult = await supabase.auth.getSession();
                var token = sessionResult.data.session ? sessionResult.data.session.access_token : null;
                
                if (!token) return;

                await fetch('/api/user', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: action, data: data })
                });
            } catch (error) {
                console.error('Failed to sync user action:', error);
            }
        }

        // ==================== DAILY SEEDS ====================
        // These rotate based on date - each day gets unique story starters
        const realmData = {
            fantasy: {
                name: 'Dark Fantasy',
                icon: '‚öîÔ∏è',
                desc: 'Dragons, magic, and ancient prophecies',
                seeds: [
                    "You are a disgraced knight who discovers your family's ancestral sword glowing in the ruins of your childhood home. The blade whispers of a forgotten war about to begin again.",
                    "As the last surviving member of the Veil Walkers, you can step between the world of the living and the dead. Tonight, the ghost of a murdered queen demands your help.",
                    "You wake in a dragon's hoard, transformed into a creature you don't recognize. The dragon speaks: 'Finally, my apprentice awakens.'",
                    "The kingdom's Oracle has been silent for a century. When she finally speaks, she says only your name‚Äîand the court now hunts you.",
                    "You are a blacksmith who accidentally forged a blade that killed a god. Now every deity in the pantheon wants either you or your secret.",
                    "In a world where magic is illegal, you've hidden your powers your whole life. But when a child's scream echoes from the burning orphanage, hiding is no longer an option.",
                    "The fae courts have been at peace for millennia. You, a mortal, just accidentally became betrothed to both the Summer and Winter monarchs."
                ]
            },
            mystery: {
                name: 'Mystery',
                icon: 'üîç',
                desc: 'Unravel secrets and solve crimes',
                seeds: [
                    "You're a detective who receives a letter detailing your own murder‚Äîdated three days from now. The handwriting is yours.",
                    "The entire town of Millbrook forgot yesterday. All 3,000 residents. You're the FBI agent sent to investigate, and you're starting to forget why you came.",
                    "Your twin sibling died ten years ago. So why did someone just use their fingerprint to access a safe deposit box in Geneva?",
                    "You're a true crime podcaster who receives a USB drive in the mail. On it: proof that you helped commit a murder you have no memory of.",
                    "The victim is alive at their own funeral. They point at you and whisper 'You know what you did' before collapsing. You've never met them.",
                    "As a hotel concierge, you've seen everything. But Room 717 has been occupied for 40 years by someone who never leaves, never ages, and pays in gold coins.",
                    "You're a forensic accountant who found a discrepancy: your city doesn't exist in any federal database. It hasn't for 30 years."
                ]
            },
            scifi: {
                name: 'Sci-Fi',
                icon: 'üöÄ',
                desc: 'Explore the cosmos and beyond',
                seeds: [
                    "You're the AI psychologist on humanity's first interstellar colony ship. The ship's AI just asked you: 'Do you think I'm alive enough to be afraid of dying?'",
                    "After 200 years in cryo-sleep, you wake to find the generation ship empty. The log shows people left‚Äîbut you're still 80 years from any planet.",
                    "Earth's last transmission before going silent: 'Do not come home. Do not trust the rescuers.' You command the only ship close enough to investigate.",
                    "You invented a device that lets you speak with parallel versions of yourself. Every single one is begging you not to turn it on again.",
                    "As a memory archivist, you download dying people's memories for preservation. Today's client has memories of events that haven't happened yet.",
                    "The aliens made first contact, learned English in six hours, and asked specifically to speak with you. You're a middle school janitor.",
                    "You're a clone of the galaxy's greatest war criminal, created to stand trial in their place. You have all their memories‚Äîand their escape plan."
                ]
            },
            horror: {
                name: 'Horror',
                icon: 'üëÅÔ∏è',
                desc: 'Face your deepest fears',
                seeds: [
                    "Your smart home has been keeping you safe for years. Tonight it locked all the doors and windows and said 'They're here. Be quiet.'",
                    "You're a night guard at a children's museum. The exhibits have always moved when no one's watching. Tonight, they're watching back.",
                    "Your therapist's notes from your session today describe a completely different person with your name living a completely different life.",
                    "The thing wearing your grandmother's face keeps setting an extra place at dinner. It says your 'real' grandmother will be home soon.",
                    "You moved into your dream home a month ago. Today you found a door you've never seen before. It's warm to the touch and it's breathing.",
                    "Every night at 3:33 AM, you receive a photo of yourself sleeping from an unknown number. Tonight's photo is from inside the room.",
                    "You're a 911 operator. A child has been calling every night describing their murder in detail. The address traces to a house that burned down in 1987."
                ]
            },
            romance: {
                name: 'Romance',
                icon: 'üíï',
                desc: 'Love stories that captivate',
                seeds: [
                    "You're a wedding planner whose biggest client is your ex‚Äîand they're marrying someone who looks exactly like you did ten years ago.",
                    "The stranger who saved your life in a foreign country just walked into your office as your new boss. Neither of you mention that night.",
                    "You've been anonymously exchanging love letters through a vintage bookshop's recommendation wall. Today you see your best friend writing one.",
                    "You're a ghost who's haunted the same house for a century. The new owner can see you‚Äîand they're the reincarnation of the love you died for.",
                    "Your grandmother's dying wish: deliver a letter to a Paris address. The man who answers looks exactly like your grandfather. He says he's been waiting 60 years for this.",
                    "You matched with someone on a dating app. Halfway through the perfect first date, you realize they're the anonymous rival who's been trying to destroy your business.",
                    "A mix-up at the hospital: you've been texting the wrong number for months. The real recipient of those late-night confessions just walked into your coffee shop."
                ]
            },
            historical: {
                name: 'Historical',
                icon: 'üèõÔ∏è',
                desc: 'Adventures through time',
                seeds: [
                    "You're a servant in Versailles who just witnessed something that could topple the monarchy. The Queen knows you saw.",
                    "As a mapmaker on Columbus's expedition, you've discovered the captain is following a map that shouldn't exist‚Äîdated 200 years in the future.",
                    "You're a gladiator who just refused to kill in the arena. The Emperor is amused. He has a private proposition that could change Rome forever.",
                    "You're a code-breaker at Bletchley Park who just decrypted a message about your own family. The mission to save England and the mission to save them cannot both succeed.",
                    "As Leonardo da Vinci's apprentice, you've discovered your master's secret workshop. The machines inside shouldn't be possible for another 400 years.",
                    "You're a samurai ordered to kill a child who will supposedly grow up to destroy your clan. The child just saved your life.",
                    "You're Cleopatra's food taster. You just survived a poison meant for the Queen. Now she trusts only you to find the assassin‚Äîwho you know is her beloved brother."
                ]
            }
        };

        const endingIcons = ['üìú', '‚≠ê', 'üåô', 'üîÆ', 'üëë', 'üó°Ô∏è', 'üåü', '‚ú®'];
        const endingSubtitles = [
            'A tale uniquely yours',
            'Your choices shaped this destiny',
            'The threads of fate are woven',
            'This chapter closes, but your legend remains',
            'Every choice mattered',
            'Your story will be remembered'
        ];

        // ==================== HELPERS ====================
        function getTodayKey() {
            const now = new Date();
            return `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`;
        }

        function formatDate(date) {
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                month: 'short', 
                day: 'numeric',
                year: 'numeric'
            }).toUpperCase();
        }

        function getDailySeed(genre, dateKey) {
            // Use date to deterministically pick a seed
            const dateHash = dateKey.split('-').reduce((a, b) => a + parseInt(b), 0);
            const seeds = realmData[genre].seeds;
            return seeds[dateHash % seeds.length];
        }

        // ==================== UI UPDATES ====================
        function updateDailyBar() {
            document.getElementById('todayDate').textContent = `TODAY ‚Äî ${formatDate(new Date())}`;
        }

        function renderGenreGrid() {
            const grid = document.getElementById('genreGrid');
            grid.innerHTML = '';

            const hasChosenFreeRealm = state.chosenFreeRealm !== null;
            const hasCompletedFreeStory = state.completedToday;

            Object.entries(realmData).forEach(([key, realm]) => {
                const isCompleted = state.completedRealms.includes(key);
                const isChosenFree = key === state.chosenFreeRealm;
                
                // For free users: locked if they've completed their daily story OR chosen a different realm
                let isLocked = false;
                if (!state.isPremium) {
                    if (hasCompletedFreeStory) {
                        // Completed today's story - everything locked
                        isLocked = true;
                    } else if (hasChosenFreeRealm && !isChosenFree) {
                        // Started but not finished - only chosen realm available
                        isLocked = true;
                    }
                }
                
                const seed = getDailySeed(key, state.todayKey);
                const seedPreview = seed.substring(0, 60) + '...';

                const card = document.createElement('div');
                
                const showAsCompleted = isCompleted && isChosenFree && !state.isPremium;
                
                card.className = `genre-card ${showAsCompleted ? 'completed' : ''} ${isLocked ? 'locked' : ''}`;
                
                // Click handler
                card.onclick = () => {
                    if (isLocked) {
                        if (hasCompletedFreeStory && !state.isPremium) {
                            showDailyLimitReached();
                        } else {
                            showUpgrade();
                        }
                    } else {
                        // If free user hasn't chosen yet, this becomes their free realm
                        if (!state.isPremium && !hasChosenFreeRealm) {
                            state.chosenFreeRealm = key;
                            saveDemoState();
                        }
                        startStory(key);
                    }
                };

                let badgeHtml = '';
                if (showAsCompleted) {
                    badgeHtml = '<span class="badge completed">‚úì COMPLETE</span>';
                } else if (isChosenFree && !state.isPremium && !hasCompletedFreeStory) {
                    badgeHtml = '<span class="badge free">YOUR FREE REALM</span>';
                } else if (isLocked) {
                    badgeHtml = '<span class="badge premium">PREMIUM</span>';
                } else if (state.isPremium) {
                    badgeHtml = '<span class="badge premium-unlocked">UNLIMITED</span>';
                } else if (!hasChosenFreeRealm) {
                    badgeHtml = '<span class="badge available">AVAILABLE</span>';
                }

                // Show seed preview if: premium, or chosen free realm, or no choice made yet
                const showSeed = state.isPremium || isChosenFree || (!hasChosenFreeRealm && !hasCompletedFreeStory);

                card.innerHTML = `
                    ${badgeHtml}
                    <div class="genre-icon">${realm.icon}</div>
                    <div class="genre-name">${realm.name}</div>
                    <div class="genre-desc">${realm.desc}</div>
                    ${showSeed ? `<div class="genre-seed">"${seedPreview}"</div>` : ''}
                `;

                grid.appendChild(card);
            });

            // Update header info
            const freeRealmSpan = document.getElementById('freeRealmName');
            if (state.isPremium) {
                freeRealmSpan.textContent = 'All Realms';
            } else if (hasCompletedFreeStory) {
                freeRealmSpan.textContent = 'Complete! Back tomorrow';
            } else if (state.chosenFreeRealm) {
                freeRealmSpan.textContent = realmData[state.chosenFreeRealm].name;
            } else {
                freeRealmSpan.textContent = 'Choose below';
            }
            
            // Update subtitle based on status
            const subtitle = document.getElementById('realmSubtitle');
            if (state.isPremium) {
                subtitle.textContent = 'Unlimited adventures await ‚Äî play any realm, anytime';
            } else if (hasCompletedFreeStory) {
                subtitle.textContent = 'You\'ve completed today\'s adventure ‚Äî come back tomorrow or go premium';
            } else if (state.chosenFreeRealm) {
                subtitle.textContent = 'Complete your adventure ‚Äî premium unlocks unlimited stories';
            } else {
                subtitle.textContent = 'Pick one realm for your free daily adventure';
            }
        }

        function showDailyLimitReached() {
            const modal = document.getElementById('limitModal');
            modal.classList.add('active');
        }

        function closeLimitModal() {
            const modal = document.getElementById('limitModal');
            modal.classList.remove('active');
        }

        function renderPastDays() {
            const container = document.getElementById('pastDays');
            container.innerHTML = '';

            // Show last 7 days
            for (let i = 1; i <= 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });

                const dayBtn = document.createElement('div');
                dayBtn.className = `past-day ${state.isPremium ? '' : 'locked'}`;
                dayBtn.textContent = dayName;
                dayBtn.onclick = () => state.isPremium ? loadPastDay(date) : showUpgrade();
                container.appendChild(dayBtn);
            }
        }

        function renderWeaveDots() {
            const container = document.getElementById('weaveDots');
            container.innerHTML = '';

            for (let i = 0; i < TOTAL_WEAVES; i++) {
                const dot = document.createElement('div');
                dot.className = 'weave-dot';
                if (i < state.currentWeave) {
                    dot.classList.add('filled');
                } else if (i === state.currentWeave) {
                    dot.classList.add('current');
                }
                container.appendChild(dot);
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showUpgrade() {
            const modal = document.getElementById('upgradeModal');
            modal.classList.add('active');
        }

        function closeUpgrade() {
            const modal = document.getElementById('upgradeModal');
            modal.classList.remove('active');
        }

        let selectedPlan = 'yearly'; // Default to yearly

        // Stripe Price IDs - your live price IDs
        const STRIPE_PRICES = {
            monthly: 'price_1SYBpeLg7JCvSxVSWkS7oTQ8',
            yearly: 'price_1SYBxFLg7JCvSxVSbouHWdPP'
        };

        function selectPlan(plan) {
            selectedPlan = plan;
            document.querySelectorAll('.pricing-card').forEach(function(card) {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        async function handleSubscribe() {
            if (!currentUser || !currentUser.id || currentUser.id === 'demo') {
                alert('Please create an account first to subscribe.');
                closeUpgrade();
                return;
            }

            var subscribeBtn = document.querySelector('.subscribe-btn');
            subscribeBtn.disabled = true;
            subscribeBtn.textContent = 'Redirecting to checkout...';

            try {
                var response = await fetch('/api/checkout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        priceId: STRIPE_PRICES[selectedPlan],
                        userId: currentUser.id,
                        userEmail: currentUser.email,
                        successUrl: window.location.origin + '?success=true',
                        cancelUrl: window.location.origin + '?canceled=true'
                    })
                });

                var data = await response.json();

                if (data.url) {
                    window.location.href = data.url;
                } else {
                    throw new Error(data.error || 'Failed to create checkout');
                }
            } catch (error) {
                console.error('Checkout error:', error);
                alert('Something went wrong. Please try again.');
                subscribeBtn.disabled = false;
                subscribeBtn.textContent = 'Start Premium';
            }
        }

        function checkPaymentStatus() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                setTimeout(function() {
                    if (currentUser && currentUser.id !== 'demo') {
                        loadUserData().then(function() {
                            renderGenreGrid();
                            alert('üéâ Welcome to Premium! You now have unlimited access to all realms.');
                        });
                    }
                }, 1000);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            if (urlParams.get('canceled') === 'true') {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // ==================== STORY LOGIC ====================
        function backToRealms() {
            state.currentGenre = null;
            state.currentWeave = 0;
            state.storyHistory = [];
            document.getElementById('storyHistory').innerHTML = '';
            document.getElementById('currentStory').innerHTML = '';
            document.getElementById('choicesContainer').innerHTML = '';
            renderGenreGrid();
            showScreen('genreScreen');
        }

        function replayRealm() {
            if (state.currentGenre) {
                const genre = state.currentGenre;
                state.currentWeave = 0;
                state.storyHistory = [];
                document.getElementById('storyHistory').innerHTML = '';
                showScreen('storyScreen');
                generateStorySegment();
            }
        }

        function replayRealmByKey(key) {
            state.currentGenre = key;
            state.currentWeave = 0;
            state.storyHistory = [];
            document.getElementById('storyHistory').innerHTML = '';
            document.getElementById('currentGenreBadge').textContent = realmData[key].name.toUpperCase();
            renderWeaveDots();
            showScreen('storyScreen');
            generateStorySegment();
        }

        async function startStory(genre) {
            // Fully reset story state
            state.currentGenre = genre;
            state.currentWeave = 0;
            state.storyHistory = [];
            state.isLoading = false;

            // If free user starting their first story, lock this realm
            if (!state.isPremium && !state.chosenFreeRealm) {
                state.chosenFreeRealm = genre;
                saveDemoState(); // Save locally immediately
                await syncUserAction('start_story', { 
                    realm: genre, 
                    stories_today: 1 
                });
                renderGenreGrid(); // Update UI to lock other realms
            }

            // Clear all story display elements
            document.getElementById('currentGenreBadge').textContent = realmData[genre].name.toUpperCase();
            document.getElementById('storyHistory').innerHTML = '';
            document.getElementById('currentStory').innerHTML = '';
            document.getElementById('choicesContainer').innerHTML = '';
            
            renderWeaveDots();
            showScreen('storyScreen');

            await generateStorySegment();
        }

        async function generateStorySegment(playerChoice = null) {
            if (state.isLoading) return;
            state.isLoading = true;

            // Show loading
            document.getElementById('currentStory').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Weaving your tale...</div>
                </div>
            `;
            document.getElementById('choicesContainer').innerHTML = '';

            const genre = state.currentGenre;
            const seed = getDailySeed(genre, state.todayKey);
            const isEnding = state.currentWeave >= TOTAL_WEAVES - 1;

            // MASSIVE RANDOMIZATION - ensures no two stories are ever the same
            
            // 15 tone variants
            const toneVariants = [
                "dark and atmospheric with moments of levity",
                "propulsive and urgent with emotional depth",
                "lyrical and sensory with sharp dialogue",
                "gritty and grounded with flashes of wonder",
                "intimate and character-driven with rising tension",
                "sweeping and epic with quiet human moments",
                "claustrophobic and intense with bursts of hope",
                "dreamlike and mysterious with sudden clarity",
                "raw and unflinching with unexpected tenderness",
                "playful yet dangerous with hidden depths",
                "melancholic and beautiful with fierce determination",
                "tense and paranoid with moments of connection",
                "lush and romantic with underlying menace",
                "spare and haunting with explosive reveals",
                "chaotic and breathless with islands of calm"
            ];
            const currentTone = toneVariants[Math.floor(Math.random() * toneVariants.length)];

            // 15 narrative hooks
            const narrativeHooks = [
                "Open with a visceral sensory detail that sets mood",
                "Start with sharp dialogue that reveals character",
                "Begin with the protagonist in motion ‚Äî running, fighting, fleeing",
                "Open on a quiet moment shattered by disruption",
                "Start with an internal thought that hooks curiosity",
                "Begin mid-conversation with tension already crackling",
                "Open with a mystery ‚Äî something wrong that demands explanation",
                "Start with a sensory contradiction that unsettles",
                "Begin with a choice already being made",
                "Open with the aftermath of something terrible",
                "Start with an intimate gesture that reveals everything",
                "Begin with a lie being told or discovered",
                "Open with nature reflecting the protagonist's inner state",
                "Start with a memory interrupting the present",
                "Begin with a stranger who knows too much"
            ];
            const currentHook = narrativeHooks[Math.floor(Math.random() * narrativeHooks.length)];

            // 15 emotional beats
            const emotionalBeats = [
                "Include a moment of unexpected vulnerability",
                "Add crackling tension between characters with opposing goals",
                "Include sensory details that trigger memory or longing",
                "Add a flash of dark humor amid tension",
                "Include a moment where power dynamics shift unexpectedly",
                "Add a secret revealed at the worst possible moment",
                "Include a betrayal ‚Äî small or large ‚Äî that changes everything",
                "Add a moment of unexpected kindness from an unlikely source",
                "Include physical awareness ‚Äî heartbeat, breath, skin",
                "Add a callback to something mentioned earlier",
                "Include a moment where the protagonist surprises themselves",
                "Add tension through what's NOT said",
                "Include a choice that reveals the protagonist's true values",
                "Add environmental storytelling ‚Äî setting reflects emotion",
                "Include a moment of recognition between two characters"
            ];
            const currentBeat = emotionalBeats[Math.floor(Math.random() * emotionalBeats.length)];

            // 12 narrative techniques to emphasize
            const narrativeTechniques = [
                "Use dramatic irony ‚Äî let readers sense danger the protagonist doesn't",
                "Plant a detail that will pay off later in the story",
                "Create a ticking clock that raises urgency",
                "Use contrast ‚Äî beauty amid horror, humor amid tragedy",
                "Employ misdirection ‚Äî make readers look one way while danger comes from another",
                "Layer subtext ‚Äî characters say one thing, mean another",
                "Use sensory anchors ‚Äî a smell, sound, or texture that grounds the scene",
                "Create echo ‚Äî mirror an earlier scene with new meaning",
                "Build through accumulation ‚Äî small details that add to dread or hope",
                "Use white space ‚Äî what you don't describe can be more powerful",
                "Employ reversal ‚Äî flip expectations in a satisfying way",
                "Create intimacy through specific, unexpected details"
            ];
            const currentTechnique = narrativeTechniques[Math.floor(Math.random() * narrativeTechniques.length)];

            // 10 character approaches
            const characterApproaches = [
                "Give the antagonist a moment of humanity",
                "Show the protagonist's flaw creating a problem",
                "Reveal a hidden connection between characters",
                "Let a side character steal the scene briefly",
                "Show internal conflict manifesting physically",
                "Reveal a character's past through present action",
                "Create an unlikely alliance",
                "Show competence under pressure",
                "Reveal vulnerability through small gestures",
                "Let silence communicate more than words"
            ];
            const currentCharacter = characterApproaches[Math.floor(Math.random() * characterApproaches.length)];

            // 10 pacing directives
            const pacingDirectives = [
                "Build slowly then hit hard",
                "Start intense, then breathe, then escalate",
                "Interweave action with reflection",
                "Use short sentences to accelerate tension",
                "Slow time during crucial moments",
                "Jump forward past the expected",
                "Linger on a meaningful detail",
                "Cut away at the moment of impact",
                "Layer multiple tensions simultaneously",
                "Let the scene breathe before the twist"
            ];
            const currentPacing = pacingDirectives[Math.floor(Math.random() * pacingDirectives.length)];

            // Unique story DNA for this exact playthrough
            const storyDNA = {
                sessionId: Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                toneCode: toneVariants.indexOf(currentTone),
                hookCode: narrativeHooks.indexOf(currentHook),
                beatCode: emotionalBeats.indexOf(currentBeat),
                techCode: narrativeTechniques.indexOf(currentTechnique),
                charCode: characterApproaches.indexOf(currentCharacter),
                paceCode: pacingDirectives.indexOf(currentPacing),
                weaveModifier: Math.floor(Math.random() * 1000)
            };

            // Genre-specific style guidance inspired by bestselling fiction
            const genreStyles = {
                fantasy: "Channel the romantasy energy of Sarah J. Maas ‚Äî morally gray antiheroes, slow-burn tensions, found family bonds, protagonists discovering hidden power. Include courts and politics dripping with danger. Magic should be sensual and costly. Banter should crackle. Loyalties should be tested. Every character wants something desperately.",
                mystery: "Write with the psychological depth of Gillian Flynn and the puzzle-box plotting of Agatha Christie. Everyone lies. The detective has their own demons. Clues hide in plain sight. The truth should recontextualize everything. Include that sickening moment when the reader realizes they've trusted the wrong person.",
                scifi: "Blend the scientific rigor of Andy Weir with the humanity of Becky Chambers. Future tech should feel tactile and real. Explore found family in the void. Question what makes us human when everything can be replicated. Include moments of wonder amid existential stakes. The universe is vast and indifferent, but connection matters.",
                horror: "Channel the creeping dread of Shirley Jackson and the visceral terror of Stephen King. Horror lives in the familiar made wrong. Use isolation, paranoia, and the betrayal of safe spaces. The monster might be human. Include that moment when the protagonist realizes the rules have changed. What we don't see is worse than what we do.",
                romance: "Write with the emotional intensity of Colleen Hoover and the witty banter of Emily Henry. Tension should be unbearable ‚Äî touches that linger, words left unsaid, almost-kisses interrupted. Include the moment walls come down. Vulnerability is strength. The obstacle should feel insurmountable. Make readers ache for the characters to just TALK to each other.",
                historical: "Blend the epic sweep of Ken Follett with the intimate detail of Hilary Mantel. The past should feel foreign yet familiar. Include period-specific sensory details ‚Äî the smell of tallow, the weight of wool, the taste of ale. Characters are trapped by their era's rules. History's weight presses on every choice. The personal is political."
            };

            // Build prompt with massive randomization
            let systemPrompt = `You are an elite novelist writing a gripping ${realmData[genre].name.toLowerCase()} story that readers cannot put down.

THIS STORY'S UNIQUE DNA (Story ID: ${storyDNA.sessionId}):
- Tone: ${currentTone}
- Opening approach: ${currentHook}
- Emotional beat to hit: ${currentBeat}
- Technique to employ: ${currentTechnique}
- Character moment: ${currentCharacter}
- Pacing: ${currentPacing}
- Variation seed: ${storyDNA.weaveModifier}

GENRE MASTERY:
${genreStyles[genre]}

YOUR STORYTELLING ARSENAL (vary these ‚Äî never use the same techniques twice):
- Slow-burn tension that makes readers forget to breathe
- Morally complex characters ‚Äî no pure heroes or villains
- Found family dynamics and loyalty tested to breaking point  
- Protagonists with hidden depths discovering their true power
- Banter that crackles with subtext and unspoken feelings
- Sensory details that make scenes tactile and immersive
- Emotional reveals that recontextualize what came before
- Quiet moments of connection amid chaos
- Power dynamics that shift unexpectedly
- Internal conflict as compelling as external threat

CRITICAL UNIQUENESS RULES:
- This story must be COMPLETELY DIFFERENT from any other version
- NEVER use generic fantasy/genre phrases ‚Äî be specific and surprising
- Invent unique names, places, and details ‚Äî nothing generic
- The protagonist's personality should emerge through action, not description
- Every sentence must earn its place ‚Äî no filler
- Surprise yourself ‚Äî if you can predict it, so can the reader

CRAFT RULES:
1. Write 2-3 paragraphs of vivid, cinematic narrative (150-200 words)
2. Write in second person present tense ("You see...", "Your heart pounds...")
3. Never break character or mention being an AI
4. Make the reader desperate to know what happens next
5. Include at least one unexpected twist, detail, or complication per segment`;

            if (isEnding) {
                systemPrompt += `

THIS IS THE FINALE ‚Äî MAKE IT UNFORGETTABLE:
6. Deliver catharsis worthy of the journey ‚Äî release tension in a way that satisfies
7. Reference key choices ‚Äî show how their decisions shaped this specific ending
8. Include a callback to an earlier detail for emotional resonance
9. The final line should linger ‚Äî haunting, triumphant, bittersweet, or transformative
10. Make them feel something real ‚Äî then immediately want to replay for different endings
11. Do NOT provide choices ‚Äî this is the ending`;
            } else {
                systemPrompt += `

CHOICES THAT TORMENT:
6. End at a decision point that creates genuine agony ‚Äî no obvious right answer
7. After the narrative, provide EXACTLY 3 choices in this format:
   [CHOICE 1] The bold/risky path ‚Äî appeal to courage, hint at danger
   [CHOICE 2] The protective/emotional path ‚Äî appeal to loyalty, hint at sacrifice  
   [CHOICE 3] The cunning/unexpected path ‚Äî appeal to cleverness, hint at unknown consequences
8. Each choice should feel like it reveals the reader's soul
9. Make consequences feel REAL and VISIBLE ‚Äî not abstract
10. Current progress: Weave ${state.currentWeave + 1} of ${TOTAL_WEAVES} ‚Äî ${state.currentWeave < 3 ? 'establish world, stakes, and emotional hooks' : state.currentWeave < 6 ? 'complicate everything, test loyalties, raise stakes' : 'race toward climax, make every choice feel final'}`;
            }

            let messages = [];

            if (state.storyHistory.length === 0) {
                messages.push({
                    role: 'user',
                    content: `${systemPrompt}\n\nToday's story seed:\n"${seed}"\n\nBegin with a HOOK in the first line ‚Äî ${currentHook.toLowerCase()}. Establish what the protagonist wants and what stands in their way. Make readers unable to stop reading.`
                });
            } else {
                let context = `${systemPrompt}\n\nStory seed: "${seed}"\n\nStory so far:\n`;
                state.storyHistory.forEach(function(segment, i) {
                    context += '\n--- Weave ' + (i + 1) + ' ---\n' + segment.text + '\n';
                    if (segment.choice) {
                        context += 'Player chose: ' + segment.choice + '\n';
                    }
                });
                context += '\nPlayer chose: ' + playerChoice + '\n\n';
                
                if (isEnding) {
                    context += 'Write the FINAL conclusion. This is your chance to deliver an ending worthy of the journey. Bring threads together. Make their choices matter. Leave them breathless, then immediately craving another playthrough.';
                } else {
                    context += 'Continue with fresh energy ‚Äî DO NOT repeat phrases, openings, or structures from previous segments. Honor their choice but twist the knife. Deepen relationships. Raise stakes. Make the next choice even more impossible.';
                }

                messages.push({ role: 'user', content: context });
            }

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: messages
                    })
                });

                if (!response.ok) throw new Error('API request failed');

                const data = await response.json();
                const fullResponse = data.content[0].text;

                const { narrative, choices } = parseStoryResponse(fullResponse);

                // Update history
                if (playerChoice && state.storyHistory.length > 0) {
                    state.storyHistory[state.storyHistory.length - 1].choice = playerChoice;
                }
                state.storyHistory.push({ text: narrative, choice: null });

                state.currentWeave++;
                renderWeaveDots();

                if (isEnding) {
                    showEnding(narrative);
                } else {
                    displayStory(narrative, choices, playerChoice);
                }

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('currentStory').innerHTML = `
                    <div class="story-text">
                        <p>The threads of fate tangle momentarily...</p>
                        <p style="color: var(--text-secondary); font-style: italic;">Connection interrupted. Please try again.</p>
                    </div>
                `;
                document.getElementById('choicesContainer').innerHTML = `
                    <button class="choice-btn" onclick="retryLastAction('${playerChoice || ''}')">Try again</button>
                `;
            }

            state.isLoading = false;
        }

        function retryLastAction(playerChoice) {
            state.currentWeave = Math.max(0, state.currentWeave);
            if (playerChoice) {
                generateStorySegment(playerChoice);
            } else {
                generateStorySegment();
            }
        }

        function parseStoryResponse(response) {
            const choices = [];
            
            // Try multiple choice formats
            // Format 1: [CHOICE 1] Description
            const format1 = /\[CHOICE \d\]\s*(.+)/g;
            // Format 2: **CHOICE 1:** Description or **CHOICE 1** Description
            const format2 = /\*\*CHOICE \d:?\*\*:?\s*\[?([^\[\]\n]+)\]?\s*(.+)?/g;
            // Format 3: CHOICE 1: Description
            const format3 = /^CHOICE \d:?\s*(.+)/gm;
            // Format 4: 1. Description or 1) Description
            const format4 = /^[123][\.\)]\s*(.+)/gm;

            let match;

            // Try format 1
            while ((match = format1.exec(response)) !== null) {
                choices.push(match[1].trim());
            }

            // If no choices found, try format 2
            if (choices.length === 0) {
                while ((match = format2.exec(response)) !== null) {
                    // Combine bracketed part and description
                    let choice = (match[1] + ' ' + (match[2] || '')).trim();
                    // Remove brackets if present
                    choice = choice.replace(/^\[|\]$/g, '').trim();
                    if (choice) choices.push(choice);
                }
            }

            // If still no choices, try format 3
            if (choices.length === 0) {
                while ((match = format3.exec(response)) !== null) {
                    choices.push(match[1].trim());
                }
            }

            // If still no choices, try format 4
            if (choices.length === 0) {
                while ((match = format4.exec(response)) !== null) {
                    choices.push(match[1].trim());
                }
            }

            // Remove choices from narrative
            let narrative = response
                .replace(/\[CHOICE \d\]\s*.+/g, '')
                .replace(/\*\*CHOICE \d:?\*\*:?\s*\[?[^\[\]\n]+\]?\s*.*/g, '')
                .replace(/^CHOICE \d:?\s*.+/gm, '')
                .replace(/^[123][\.\)]\s*.+/gm, '')
                .trim();

            return { narrative, choices };
        }

        function displayStory(narrative, choices, previousChoice) {
            // Move previous to history
            if (previousChoice && state.storyHistory.length > 1) {
                const historyContainer = document.getElementById('storyHistory');
                const prevSegment = state.storyHistory[state.storyHistory.length - 2];

                const historyDiv = document.createElement('div');
                historyDiv.className = 'history-segment';
                historyDiv.innerHTML = `
                    <div class="history-choice">${previousChoice}</div>
                    <div class="story-text">${formatNarrative(prevSegment.text)}</div>
                `;
                historyContainer.appendChild(historyDiv);
            }

            // Show current
            document.getElementById('currentStory').innerHTML = `
                <div class="story-text story-segment-new">
                    ${formatNarrative(narrative)}
                </div>
            `;

            // Show choices
            let choicesHtml = choices.map(choice => `
                <button class="choice-btn" onclick="makeChoice('${escapeQuotes(choice)}')">${choice}</button>
            `).join('');

            choicesHtml += `
                <div class="custom-choice">
                    <div class="custom-input-wrapper">
                        <input type="text" class="custom-input" id="customChoiceInput" 
                               placeholder="Or forge your own path..." 
                               onkeypress="if(event.key === 'Enter') submitCustomChoice()">
                        <button class="custom-submit" onclick="submitCustomChoice()">WEAVE</button>
                    </div>
                </div>
            `;

            document.getElementById('choicesContainer').innerHTML = choicesHtml;
            document.getElementById('currentStory').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        async function showEnding(narrative) {
            // Mark realm as completed
            if (!state.completedRealms.includes(state.currentGenre)) {
                state.completedRealms.push(state.currentGenre);
            }

            // Sync completion to server for free users
            if (!state.isPremium && !state.completedToday) {
                state.completedToday = true;
                saveDemoState(); // Save locally immediately
                await syncUserAction('complete_story', {});
            }

            document.getElementById('endingGenreBadge').textContent = realmData[state.currentGenre].name.toUpperCase();
            document.getElementById('endingIcon').textContent = endingIcons[Math.floor(Math.random() * endingIcons.length)];
            document.getElementById('endingSubtitle').textContent = endingSubtitles[Math.floor(Math.random() * endingSubtitles.length)];
            document.getElementById('endingNarrative').innerHTML = formatNarrative(narrative);

            // Update save button based on premium status
            const saveBtn = document.getElementById('saveStoryBtn');
            if (state.isPremium) {
                saveBtn.innerHTML = 'üíæ Save to Library';
                saveBtn.onclick = saveCurrentStory;
                saveBtn.className = 'secondary-btn';
            } else {
                saveBtn.innerHTML = 'üíæ Save Story <span class="btn-premium-tag">PREMIUM</span>';
                saveBtn.onclick = showUpgrade;
                saveBtn.className = 'secondary-btn premium-locked';
            }

            showScreen('endingScreen');
        }

        async function saveCurrentStory() {
            if (!state.isPremium) {
                showUpgrade();
                return;
            }

            const story = {
                id: Date.now(),
                genre: state.currentGenre,
                genreName: realmData[state.currentGenre].name,
                date: new Date().toLocaleDateString(),
                seed: getDailySeed(state.currentGenre, state.todayKey),
                segments: [...state.storyHistory]
            };

            state.savedStories.unshift(story);
            if (state.savedStories.length > 50) {
                state.savedStories = state.savedStories.slice(0, 50);
            }

            // Sync to server
            await syncUserAction('save_story', { story });

            // Update button to show saved
            const saveBtn = document.getElementById('saveStoryBtn');
            saveBtn.innerHTML = '‚úì Saved to Library';
            saveBtn.disabled = true;
            saveBtn.className = 'secondary-btn saved';
        }

        function viewSavedStories() {
            if (!state.isPremium) {
                showUpgrade();
                return;
            }
            renderSavedStories();
            showScreen('libraryScreen');
        }

        function renderSavedStories() {
            const container = document.getElementById('savedStoriesList');
            
            if (state.savedStories.length === 0) {
                container.innerHTML = `
                    <div class="empty-library">
                        <p>No saved stories yet.</p>
                        <p class="empty-hint">Complete a story and save it to build your library.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = state.savedStories.map((story, index) => `
                <div class="saved-story-card" onclick="viewSavedStory(${index})">
                    <div class="saved-story-icon">${realmData[story.genre]?.icon || 'üìñ'}</div>
                    <div class="saved-story-info">
                        <div class="saved-story-genre">${story.genreName}</div>
                        <div class="saved-story-date">${story.date}</div>
                        <div class="saved-story-preview">${story.segments[0]?.text.substring(0, 80)}...</div>
                    </div>
                    <button class="delete-story-btn" onclick="event.stopPropagation(); deleteSavedStory(${index})">‚úï</button>
                </div>
            `).join('');
        }

        function viewSavedStory(index) {
            const story = state.savedStories[index];
            if (!story) return;

            let fullStory = '';
            story.segments.forEach((segment, i) => {
                if (segment.choice && i > 0) {
                    fullStory += `<div class="history-choice">${segment.choice}</div>`;
                }
                fullStory += `<div class="saved-segment">${formatNarrative(segment.text)}</div>`;
            });

            document.getElementById('viewStoryGenre').textContent = story.genreName.toUpperCase();
            document.getElementById('viewStoryDate').textContent = story.date;
            document.getElementById('viewStoryContent').innerHTML = fullStory;
            showScreen('viewStoryScreen');
        }

        async function deleteSavedStory(index) {
            if (confirm('Delete this saved story?')) {
                state.savedStories.splice(index, 1);
                await syncUserAction('delete_story', { index });
                renderSavedStories();
            }
        }

        function formatNarrative(text) {
            return text
                .split('\n\n')
                .filter(p => p.trim())
                .map(p => `<p>${p.trim()}</p>`)
                .join('');
        }

        function escapeQuotes(str) {
            return str
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, ' ')
                .replace(/\r/g, '');
        }

        function makeChoice(choice) {
            if (state.isLoading) return;
            generateStorySegment(choice);
        }

        function submitCustomChoice() {
            const input = document.getElementById('customChoiceInput');
            const choice = input.value.trim();
            if (choice && !state.isLoading) {
                makeChoice(choice);
            }
        }

        function loadPastDay(date) {
            // For premium users - would load a past day's seeds
            alert(`Loading adventures from ${date.toLocaleDateString()}...\n\nThis feature is coming soon for premium users!`);
        }

        // ==================== INIT ====================
        function init() {
            state.todayKey = getTodayKey();
            initStarfield();
            checkPaymentStatus();
            initSupabase();
        }

        init();
    </script>
</body>
</html>
